{
    "variables": {
        "aws_vpc_id": "",
        "subnet_id": "",
        "region": "",
        "source_ami": "",
        "version": "{{isotime \"2006-01-02\"}}-{{env `BUILD_NUMBER`}}",
        "user": "{{env `USER`}}"
    },
    "builders": [{
        "type": "amazon-chroot",
        "from_scratch": "true",
        "ami_virtualization_type": "hvm",
        "region": "{{user `region`}}",
        "source_ami": "{{user `source_ami`}}",
        "ami_name": "jenkinspoc-pipeline-{{user `version`}}",
        "enhanced_networking": "false",
        "force_deregister": "true",
        "ami_description": "jenkinspoc-pipeline-{{user `version`}}",
        "root_volume_size": 5,
        "root_device_name": "xvda",
        "ami_block_device_mappings": [{
            "device_name": "xvda",
            "delete_on_termination": true,
            "volume_type": "gp2"
        }],
        "pre_mount_commands": [
             "parted {{.Device}} mklabel msdos mkpart primary 1M 100% set 1 boot on print",
             "mkfs.ext4 {{.Device}}1"
        ],
        "ami_regions": [
            "us-west-2"
        ],
        "tags": {
            "Product": "jenkinspoc-pipeline",
            "BaseAMIOS": "Ubuntu-14.04LTS",
            "BaseAMI": "{{user `source_ami`}}",
            "BaseRepo": "{{user `repo`}}",
            "BaseHash": "{{user `commit`}}",
            "Name": "jenkinspoc-pipeline-{{user `version`}}",
            "Created_Date": "{{isotime \"2006-01-02\"}}",
            "Created_By": "{{user `user`}}",
            "BuildSource": "jenkinspoc-pipeline"
        }
    }],
    "provisioners": [{
        "type": "shell",
        "inline": [
            "while [ ! -f /var/lib/cloud/instance/boot-finished ]; do echo 'Waiting for cloud-init ...'; sleep 1; done"
         ],
        "inline": [
            "sudo yum update -v -y",
	    "sudo yum install -y nc"
        ]
    }]
}
