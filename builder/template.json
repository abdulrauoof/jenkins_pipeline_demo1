{
    "variables": {
        "aws_vpc_id": "",
        "subnet_id": "",
        "region": "",
        "source_ami": "",
        "version": "{{isotime \"2006-01-02\"}}-{{env `BUILD_NUMBER`}}",
        "user": "{{env `USER`}}"
    },
    "builders": [{
        "type": "amazon-ebs",
        "region": "{{user `region`}}",
        "source_ami": "{{user `source_ami`}}",
        "instance_type": "t2.small",
        "ssh_username": "ec2-user",
        "ami_name": "amibuild-jenkinspoc-pipeline-{{user `version`}}",
        "enhanced_networking": "false",
        "force_deregister": "true",
        "iam_instance_profile": "ecs-jenkins-dev",
        "vpc_id": "{{user `aws_vpc_id`}}",
        "subnet_id": "{{user `subnet_id`}}",
        "ami_description": "amibuild-jenkinspoc-pipeline-{{user `version`}}",
        "ami_regions": [
            "us-west-2"
        ],
        "tags": {
            "Product": "jenkinspoc-pipeline",
            "BaseAMIOS": "ECS-optimized_AMI",
            "BaseAMI": "{{user `source_ami`}}",
            "Name": "jenkinspoc-pipeline-{{user `version`}}",
            "Created_Date": "{{isotime \"2006-01-02\"}}",
            "Created_By": "{{user `user`}}",
            "BuildSource": "amibuild-jenkinspoc-pipeline"
        }
    }],
    "provisioners": [{
        "type": "shell",
        "inline": [
            "while [ ! -f /var/lib/cloud/instance/boot-finished ]; do echo 'Waiting for cloud-init ...'; sleep 1; done"
         ],
        "inline": [
            "sudo yum update -v -y",
	    "sumdo yum install -y nc"
        ]
    },{
        "type": "shell",
        "inline": [
            "sudo apt-get -qq -y --auto-remove autoremove",
            "sudo apt-get -qq -y clean all",
            "sudo apt-get -qq -y autoclean all",
            "sudo rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*"
        ]
    }]
}
